<script>
  const params = new URLSearchParams(location.search);
  const building = (params.get('building') || '').toUpperCase();

  if (!building) {
    document.addEventListener('DOMContentLoaded', () => {
      document.body.innerHTML =
        '<div style="color:white;text-align:center;padding:20px;">Error: Invalid QR code</div>';
    });
  } else {
    const flowUrl =
      'https://default96464a8af8ed40b199e25f6b50a202.50.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/a9e622c78c9343938de7f228ab5b2df1/triggers/manual/paths/invoke/scan/' +
      encodeURIComponent(building) +
      '?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=6OFlGiieZNkvZ3AiotzCeeq4sz3ljQQQ3yN2LXhwsns';

    const firedKey = `lnqr:${building}`;
    function redirectToFlow() {
      if (sessionStorage.getItem(firedKey)) return;
      if (document.visibilityState !== 'visible') return;
      sessionStorage.setItem(firedKey, '1');
      window.location.replace(flowUrl);
    }

    // Wait up to 2.5 s *after the page is visible* before redirecting
    function waitThenRedirect() {
      setTimeout(redirectToFlow, 2500);
    }

    if (document.visibilityState === 'visible') {
      waitThenRedirect();
    } else {
      const onVis = () => {
        if (document.visibilityState === 'visible') {
          document.removeEventListener('visibilitychange', onVis);
          waitThenRedirect();
        }
      };
      document.addEventListener('visibilitychange', onVis);
    }
  }
</script>
